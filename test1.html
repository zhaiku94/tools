<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AES-256 æœ¬åœ°æ–‡ä»¶åŠ å¯†å·¥å…·</title>
    <style>
        body { 
            font-family: system-ui, sans-serif; 
            max-width: 100%; /* å®½åº¦è‡ªé€‚åº” */
            margin: 20px auto; 
            padding: 20px; 
            line-height: 1.6; 
            background: #f4f7f6; 
        }
        .card { 
            background: white; 
            max-width: 500px; /* é™åˆ¶å¡ç‰‡å®½åº¦ï¼Œé€‚é…æ¡Œé¢å’Œç§»åŠ¨ç«¯ */
            margin: 0 auto;
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }
        h2 { 
            color: #2c3e50; 
            margin-top: 0; 
        }
        input, button { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border-radius: 6px; 
            border: 1px solid #ddd; 
            box-sizing: border-box; 
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            cursor: pointer; 
            font-weight: bold; 
        }
        button:hover { 
            background: #0056b3; 
        }
        button.decrypt-btn { 
            background: #28a745; 
        }
        button.decrypt-btn:hover { 
            background: #218838; 
        }
        #status { 
            font-size: 0.9em; 
            color: #666; 
            margin-top: 10px; 
            text-align: center; 
        }
        @media (max-width: 768px) {
            .card {
                padding: 20px;
            }
            input, button {
                font-size: 16px;
            }
            h2 {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ” AES-256 æœ¬åœ°åŠ å¯†å·¥å…·</h2>
    <p style="font-size: 0.9em; color: #e67e22;">
        æ³¨æ„ï¼šæ–‡ä»¶åœ¨æµè§ˆå™¨æœ¬åœ°å¤„ç†ï¼Œç»ä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚
    </p>
    
    <input type="file" id="fileInput">
    <input type="password" id="password" placeholder="è¯·è¾“å…¥åŠ å¯†/è§£å¯†å¯†ç ">
    <button onclick="processFile('encrypt')">åŠ å¯†å¹¶ä¸‹è½½</button>
    <button onclick="processFile('decrypt')" class="decrypt-btn">è§£å¯†å¹¶ä¸‹è½½</button>
    
    <div id="status">ç­‰å¾…æ“ä½œ...</div>
</div>

<script>
    async function deriveKey(password, salt) {
        const encoder = new TextEncoder();
        const baseKey = await crypto.subtle.importKey(
            "raw", encoder.encode(password), "PBKDF2", false, ["deriveKey"]
        );
        return crypto.subtle.deriveKey(
            { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
            baseKey,
            { name: "AES-GCM", length: 256 },
            false,
            ["encrypt", "decrypt"]
        );
    }

    async function processFile(mode) {
        const fileInput = document.getElementById('fileInput');
        const password = document.getElementById('password').value;
        const status = document.getElementById('status');

        if (!fileInput.files[0] || !password) {
            alert("è¯·é€‰æ‹©æ–‡ä»¶å¹¶è¾“å…¥å¯†ç ");
            return;
        }

        const file = fileInput.files[0];
        status.innerText = "æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...";

        try {
            const arrayBuffer = await file.arrayBuffer();
            let resultBuffer;
            let fileName = file.name;

            if (mode === 'encrypt') {
                const salt = crypto.getRandomValues(new Uint8Array(16));
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const key = await deriveKey(password, salt);
                
                const encryptedContent = await crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    arrayBuffer
                );

                resultBuffer = new Uint8Array(salt.byteLength + iv.byteLength + encryptedContent.byteLength);
                resultBuffer.set(salt, 0);
                resultBuffer.set(iv, 16);
                resultBuffer.set(new Uint8Array(encryptedContent), 28);
                fileName += ".enc";
            } else {
                const data = new Uint8Array(arrayBuffer);
                const salt = data.slice(0, 16);
                const iv = data.slice(16, 28);
                const content = data.slice(28);
                const key = await deriveKey(password, salt);

                const decryptedContent = await crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    content
                );
                resultBuffer = decryptedContent;
                fileName = fileName.replace(".enc", "");
            }

            const blob = new Blob([resultBuffer]);
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            status.innerText = mode === 'encrypt' ? "åŠ å¯†å®Œæˆï¼" : "è§£å¯†å®Œæˆï¼";

        } catch (e) {
            console.error(e);
            status.innerText = "é”™è¯¯ï¼šå¯èƒ½æ˜¯å¯†ç é”™è¯¯æˆ–æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼";
        }
    }
</script>

</body>
</html>