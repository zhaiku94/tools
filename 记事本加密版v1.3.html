<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç¦»çº¿ç¬”è®° - åŠ å¯†å¢å¼ºç‰ˆ</title>
    <style>
        :root { --primary: #3498db; --success: #27ae60; --bg: #f8f9fa; --sidebar: 180px; }
        body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; background: #f8f9fa; overflow: hidden; }
        #sidebar { width: var(--sidebar); background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; transition: 0.3s; z-index: 1000; }
        @media (max-width: 768px) { #sidebar { position: fixed; height: 100%; transform: translateX(-100%); } #sidebar.active { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.1); } }
        #sidebar h2 { padding: 20px; margin: 0; font-size: 1.1rem; border-bottom: 1px solid #eee; }
        #toc-list { flex-grow: 1; overflow-y: auto; }
        .toc-item { padding: 12px 20px; cursor: pointer; font-size: 14px; color: #555; border-bottom: 1px solid #f9f9f9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .toc-item:hover { background: #f0f7ff; color: var(--primary); }
        
        #main-content { flex-grow: 1; overflow-y: auto; padding: 0 20px 20px; scroll-behavior: instant }
        .header-fixed-wrap { position: sticky; top: 0; background: var(--bg); z-index: 100; width: 100%; padding-top: 20px; }
        .header-actions { max-width: 800px; margin: 0 auto; display: flex; align-items: center; gap: 10px; background: var(--bg); padding: 10px 0 20px 0; }
        
        #notes-container { padding-top: 10px; min-height: 100vh; }
        .btn-group { display: flex; gap: 8px; margin-left: auto; }
        button { border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .add-btn { background: var(--primary); color: white; }
        .save-btn { background: var(--success); color: white; }
        .mode-btn { background: #eee; color: #333; }
        .clear-btn { background: #e74c3c; color: white; }
        .menu-btn { display: none; background: none; font-size: 24px; padding: 0; cursor: pointer; }
        @media (max-width: 768px) { .menu-btn { display: block; } }

        .note-card {
            background: white; max-width: 800px; margin: 0 auto 20px; padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid var(--primary);
            position: relative; scroll-margin-top: 100px; 
        }
        .note-content { outline: none; min-height: 100px; line-height: 1.8; white-space: pre-wrap; word-break: break-word; font-size: 16px; color: #333; }
        .delete-btn { position: absolute; top: 10px; right: 10px; background: #ff7675; color: white; padding: 4px 10px; font-size: 11px; border-radius: 4px; cursor: pointer; opacity: 0; }
        .note-card:hover .delete-btn { opacity: 1; }
        body.view-mode .add-btn, body.view-mode .delete-btn { display: none; }
        body.view-mode .note-card { border-left-color: var(--success); }
        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 999; }
        #overlay.active { display: block; }

/* æ–°å¢æ ¼å¼åŒ–ç›¸å…³æ ·å¼ */
.format-group { display: flex; gap: 4px; align-items: center; }
.format-group button { 
    background: #fff; border: 1px solid #ddd; color: #555; 
    padding: 5px 10px; min-width: 35px; 
}
.format-group button:hover { background: #f0f0f0; }

/* å†…å®¹åŒºåŸŸå†…çš„æ ‡é¢˜æ ·å¼ */
.note-content h2 { margin: 10px 0 5px; color: #2c3e50; font-size: 1.4rem; border-bottom: 1px solid #eee; }
.note-content h3 { margin: 8px 0 4px; color: #34495e; font-size: 1.1rem; }
.note-content p { margin: 5px 0; }

    </style>
</head>
<body>

<div id="overlay" onclick="NoteApp.toggleSidebar()"></div>
<nav id="sidebar">
    <h2>ç›®å½•</h2>
    <div id="toc-list"></div>
</nav>
<main id="main-content">
    <div class="header-fixed-wrap">
        <div class="header-actions">
            <button class="menu-btn" onclick="NoteApp.toggleSidebar()">â˜°</button>
            <h1 style="margin:0; font-size: 1.3rem;">æ—¥å¿—</h1>
            <div class="format-group">
        <button onclick="NoteApp.exec('bold')" title="åŠ ç²—"><b>B</b></button>
        <button onclick="NoteApp.exec('italic')" title="æ–œä½“"><i>I</i></button>
        <button onclick="NoteApp.exec('formatBlock', 'h2')">H1</button>
        <button onclick="NoteApp.exec('formatBlock', 'h3')">H2</button>
        <button onclick="NoteApp.exec('formatBlock', 'p')">æ­£æ–‡</button>
    </div>
            <div class="btn-group">
                <button class="mode-btn" onclick="NoteApp.toggleMode(this)">é¢„è§ˆ</button>
                <button class="add-btn" onclick="NoteApp.add()">æ–°å¢</button>
                <button class="save-btn" onclick="NoteApp.export()">ä¿å­˜</button>
                <button class="clear-btn" onclick="NoteApp.clearAll()">æ¸…ç©º</button>
            </div>
        </div>
    </div>
    <div id="notes-container"></div>
</main>

<script id="app-data">
    // æ•°æ®å­˜å‚¨ç‚¹
    window.NOTE_DATA_STORE = /*DATA_START*/ [] /*DATA_END*/;
</script>

<script id="main-logic">
window.NoteApp = {
    isView: false,

    init() {
        const container = document.getElementById('notes-container');
        container.innerHTML = '';
        const local = JSON.parse(localStorage.getItem('my_stable_notes_v4') || '[]');
        const finalData = (window.NOTE_DATA_STORE && window.NOTE_DATA_STORE.length > 0) ? window.NOTE_DATA_STORE : local;

        if (finalData.length === 0) {
            this.add("# æ¬¢è¿ä½¿ç”¨\nåœ¨æ­¤è¾“å…¥å†…å®¹ã€‚ç‚¹å‡»ã€ä¿å­˜ã€‘æ—¶å¯è®¾ç½®å¯†ç ã€‚è¯·åŠ¡å¿…ä¿å­˜ï¼å¦åˆ™ä¸‹æ¬¡æ‰“å¼€å†…å®¹ä¼šæ¸…ç©ºâš ï¸");
        } else {
            localStorage.setItem('my_stable_notes_v4', JSON.stringify(finalData));
            finalData.forEach(item => this.render(item.id, item.text));
        }
        this.updateTOC();
    },

    render(id, text) {
        const card = document.createElement('div');
        card.className = 'note-card';
        card.id = id;
        // æ³¨æ„ï¼šè¿™é‡Œ innerHTML æ¸²æŸ“ text å­—ç¬¦ä¸²ä¸­çš„ HTML æ ‡ç­¾
        card.innerHTML = `<button class="delete-btn" onclick="NoteApp.remove('${id}')">åˆ é™¤</button>
                          <div class="note-content" contenteditable="${!this.isView}" 
                               oninput="NoteApp.save(); NoteApp.updateTOC()">${text}</div>`;
        document.getElementById('notes-container').appendChild(card);
    },

    add(text = " ") {
        const id = 'n' + Date.now();
        this.render(id, text);
        this.save();
        this.updateTOC();
        document.getElementById(id).querySelector('.note-content').focus();
    },

    remove(id) {
        if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
            document.getElementById(id).remove();
            this.save();
            this.updateTOC();
        }
    },

    exec(command, value = null) {
        // ç¡®ä¿ç„¦ç‚¹åœ¨ç¼–è¾‘åŒº
        document.execCommand(command, false, value);
    },

    save() {
        const data = Array.from(document.querySelectorAll('.note-card')).map(c => ({
            id: c.id,
            text: c.querySelector('.note-content').innerHTML // æ”¹ç”¨ innerHTML
        }));
        localStorage.setItem('my_stable_notes_v4', JSON.stringify(data));
        return data;
    },

    updateTOC() {
        const list = document.getElementById('toc-list');
        list.innerHTML = '';
        document.querySelectorAll('.note-card').forEach(c => {
            const title = c.querySelector('.note-content').innerText.split('\n')[0] || "æœªå‘½å";
            const item = document.createElement('div');
            item.className = 'toc-item';
            item.innerText = title;
            item.onclick = () => {
                c.scrollIntoView({ behavior: 'instant' });
                if(window.innerWidth <= 768) this.toggleSidebar();
            };
            list.appendChild(item);
        });
    },

    toggleMode(btn) {
        this.isView = !this.isView;
        document.body.classList.toggle('view-mode');
        document.querySelectorAll('.note-content').forEach(el => el.setAttribute('contenteditable', !this.isView));
        btn.innerText = this.isView ? "ç¼–è¾‘æ¨¡å¼" : "é¢„è§ˆæ¨¡å¼";
    },

    toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('overlay').classList.toggle('active');
    },

    async export() {

        
        const data = this.save();
        const dataStr = JSON.stringify(data);
        const password = prompt("è¯·è¾“å…¥åŠ å¯†å¯†ç ï¼ˆç•™ç©ºåˆ™å¯¼å‡ºä¸åŠ å¯†çš„æ™®é€šç‰ˆï¼‰:");
        
        const now = new Date();
const dateStr = now.getFullYear() + 
                        (now.getMonth() + 1).toString().padStart(2, '0') + 
                        now.getDate().toString().padStart(2, '0') + 
                        now.getHours().toString().padStart(2, '0') + 
                        now.getMinutes().toString().padStart(2, '0');        const styleContent = document.querySelector('style').innerHTML;
       
       const headSection = `
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
            <title>æˆ‘çš„ç¦»çº¿ç¬”è®°</title>
            <style>${styleContent}</style>
        `;
       
       
        const logicScript = document.getElementById('main-logic').innerHTML;
// --- å…³é”®ä¿®æ”¹ï¼šåŠ¨æ€è·å– body å†…å®¹ï¼Œç¡®ä¿ format-group æŒ‰é’®è¢«åŒ…å« ---
    const bodyStructure = document.body.innerHTML.split('<script')[0];
        let finalDoc = "";

        if (!password) {
            // --- æ™®é€šå¯¼å‡ºé€»è¾‘ ---
            finalDoc = `<!DOCTYPE html>
<html lang="zh-CN">
<head>${headSection}</head>
<body>${bodyStructure}
<script id="app-data">window.NOTE_DATA_STORE = ${dataStr};<\/script>
<script id="main-logic">${logicScript}\nwindow.onload = () => NoteApp.init();<\/script>
</body></html>`;
        } else {
            // --- åŠ å¯†å¯¼å‡ºé€»è¾‘ ---
            const enc = new TextEncoder();
            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
            const key = await window.crypto.subtle.deriveKey(
                { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
                keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt"]
            );
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const fullContent = `<!DOCTYPE html><html lang="zh-CN">
            <head>${headSection}</head>            
            <body>${bodyStructure}<script id="app-data">window.NOTE_DATA_STORE = ${dataStr};<\/script><script id="main-logic">${logicScript}\nwindow.onload = () => NoteApp.init();<\/script></body></html>`;
            const encrypted = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, enc.encode(fullContent));

            const exportObj = {
                ciphertext: btoa(String.fromCharCode(...new Uint8Array(encrypted))),
                iv: btoa(String.fromCharCode(...iv)),
                salt: btoa(String.fromCharCode(...salt))
            };

            finalDoc = `<!DOCTYPE html><html>
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>å·²åŠ å¯†çš„ç¬”è®°</title>
            </head>
<body style="background:#f0f2f5;font-family:sans-serif;display:flex;justify-content:center;padding-top:100px;">
<div style="background:white;padding:40px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);text-align:center;">
    <h2>ğŸ”’ ç¬”è®°å·²åŠ å¯†</h2><p>è¯·è¾“å…¥å¯†ç ä»¥è§£é”å†…å®¹</p>
    <input type="password" id="unlock-pw" onkeyup="if(event.key==='Enter') unlock()" style="padding:10px;width:200px;border:1px solid #ddd;border-radius:8px;margin-bottom:10px;font-size:16px;"><br>
    <button onclick="unlock()" style="padding:10px 20px;background:#3498db;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;">è§£å¯†å¹¶è¿›å…¥</button>
</div>
<script>
const payload = ${JSON.stringify(exportObj)};
async function unlock() {
    try {
        const pw = document.getElementById('unlock-pw').value;
        const enc = new TextEncoder();
        const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(pw), "PBKDF2", false, ["deriveKey"]);
        const key = await window.crypto.subtle.deriveKey(
            { name: "PBKDF2", salt: Uint8Array.from(atob(payload.salt), c => c.charCodeAt(0)), iterations: 100000, hash: "SHA-256" },
            keyMaterial, { name: "AES-GCM", length: 256 }, false, ["decrypt"]
        );
        const decrypted = await window.crypto.subtle.decrypt(
            { name: "AES-GCM", iv: Uint8Array.from(atob(payload.iv), c => c.charCodeAt(0)) },
            key, Uint8Array.from(atob(payload.ciphertext), c => c.charCodeAt(0))
        );
        document.open(); document.write(new TextDecoder().decode(decrypted)); document.close();
    } catch(e) { alert("å¯†ç é”™è¯¯ï¼Œè§£å¯†å¤±è´¥ï¼"); }
}
<\/script></body></html>`;
        }

        const blob = new Blob([finalDoc], { type: 'text/html' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href =url;
        a.download = `${dateStr}_${password ? 'åŠ å¯†ç‰ˆ' : 'æ™®é€šç‰ˆ'}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    },

    clearAll() {
        if (confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æœ¬åœ°ç¬”è®°å—ï¼Ÿ')) {
            localStorage.removeItem('my_stable_notes_v4');
            window.NOTE_DATA_STORE = [];
            location.reload();
        }
    }
};

window.onload = () => NoteApp.init();
</script>
</body>
</html>